<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roomhy - Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .sidebar { background-color: #111827; color: #9ca3af; }
        .sidebar-link { color: #9ca3af; font-weight: 500; transition: all 0.2s ease; display: flex; align-items: center; padding: 0.75rem 1.5rem; font-size: 0.9rem; border-left: 3px solid transparent; cursor: pointer; }
        .sidebar-link:hover { color: #f3f4f6; background-color: #1f2937; }
        .sidebar-link.active { background-color: #1f2937; color: #ffffff; border-left-color: #a855f7; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 4px; }
        #contentFrame { width: 100%; height: 100%; border: none; background-color: #f3f4f6; }
    </style>
</head>
<body class="text-slate-800">
    
    <script>
        // --- EARLY ROLE VALIDATION ---
        // Check user role immediately to prevent unauthorized access
        const userStr = localStorage.getItem('user');
        const managerStr = localStorage.getItem('manager_user');
        
        let user = null;
        try {
            user = userStr ? JSON.parse(userStr) : null;
            if (!user) {
                user = managerStr ? JSON.parse(managerStr) : null;
            }
        } catch (e) {
            user = null;
        }
        
        // If no user or wrong role, redirect immediately
        if (!user || (user.role !== 'areamanager' && user.role !== 'employee')) {
            // Redirect to appropriate login or panel
            if (user && user.role === 'owner') {
                window.location.href = '../propertyowner/admin.html';
            } else if (user && user.role === 'superadmin') {
                window.location.href = '../superadmin/superadmin.html';
            } else {
                window.location.href = '../index.html';
            }
            throw new Error('Unauthorized access');
        }

        // --- DYNAMIC PERMISSION & SIDEBAR LOGIC ---
        function safeRedirect(url) {
            try { window.location.href = url; } 
            catch (e) { document.body.innerHTML = `<div class="flex items-center justify-center h-screen bg-gray-100"><a href="${url}" class="bg-purple-600 text-white px-6 py-3 rounded-lg">Click to Login</a></div>`; }
        }

        // 1. Config for ALL possible modules
        const sidebarConfig = {
            // Core (Conditional)
            'properties': { label: 'Properties', page: 'areaproperty.html', icon: 'home' },
            'visits': { label: 'Visit Reports', page: 'visit.html', icon: 'clipboard-list' },
            'tenants': { label: 'Tenants', page: 'areatenant.html', icon: 'users' },
            'owners': { label: 'Owners', page: 'areaowner.html', icon: 'briefcase' },
            'payments': { label: 'Payments', page: 'areapayment.html', icon: 'wallet' },
            'complaints': { label: 'Complaints', page: 'complaint.html', icon: 'alert-circle' },
            'kyc': { label: 'KYC Verify', page: 'areakyc.html', icon: 'file-check' },
            'enquiries': { label: 'Enquiries', page: 'areaenq.html', icon: 'help-circle' },
            
            // DEFAULTS (Always Visible)
            'dashboard': { label: 'Dashboard', page: 'dashboard_home', icon: 'layout-dashboard' },
            'chat': { label: 'Chat', page: 'areachat.html', icon: 'message-square' },
            'reports': { label: 'Reports', page: 'areareport.html', icon: 'bar-chart-2' },
            'settings': { label: 'Settings', page: 'setting.html', icon: 'settings' }
        };

        // 2. Defaults are enforced here
        const defaultModules = ['dashboard', 'chat', 'reports', 'settings'];
        
        let allowedModules = [];

        if (user && user.role === 'areamanager') {
            // Full Access
            allowedModules = Object.keys(sidebarConfig);
        } else if (user && user.role === 'employee') {
            // Permissions from DB + Forced Defaults
            const assigned = user.permissions || [];
            // Merge assigned permissions with required defaults
            allowedModules = [...new Set([...assigned, ...defaultModules])];
        }

        function createLink(id) {
            const config = sidebarConfig[id];
            if (!config) return '';
            // Check if allowed
            if (!allowedModules.includes(id)) return '';

            const isActive = config.page === 'dashboard_home' ? 'active' : '';
            return `
                <a href="#" onclick="loadPage('${config.page}', this); return false;" class="sidebar-link ${isActive}">
                    <i data-lucide="${config.icon}" class="w-5 h-5 mr-3"></i> ${config.label}
                </a>
            `;
        }

        function loadPage(pageUrl, element) {
            if (element) {
                document.querySelectorAll('.sidebar-link').forEach(el => el.classList.remove('active'));
                element.classList.add('active');
            }
            const frame = document.getElementById('contentFrame');
            const dashboardView = document.getElementById('dashboard-view');

            if (pageUrl === 'dashboard_home') {
                dashboardView.classList.remove('hidden');
                frame.classList.add('hidden');
                document.getElementById('welcomeArea').innerText = 'Dashboard';
            } else {
                dashboardView.classList.add('hidden');
                frame.classList.remove('hidden');
                frame.src = pageUrl;
                const key = Object.keys(sidebarConfig).find(k => sidebarConfig[k].page === pageUrl);
                if(key) document.getElementById('welcomeArea').innerText = sidebarConfig[key].label;
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (!user) return; 
            const nav = document.getElementById('dynamicSidebarNav');
            let html = '';

            // Render Structure
            // 1. Dashboard (Always top)
            html += createLink('dashboard');

            // 2. Management (Conditional)
            const mgmt = ['properties', 'visits', 'tenants', 'owners'];
            if(mgmt.some(id => allowedModules.includes(id))) {
                html += `<div class="px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4">Management</div>`;
                mgmt.forEach(id => html += createLink(id));
            }

            // 3. Operations (Conditional)
            const ops = ['payments', 'complaints', 'kyc', 'enquiries'];
            if(ops.some(id => allowedModules.includes(id))) {
                html += `<div class="px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4">Operations</div>`;
                ops.forEach(id => html += createLink(id));
            }

            // 4. System (Default + Conditional)
            // Chat, Reports, Settings are forced defaults
            const sys = ['chat', 'reports', 'settings']; 
            html += `<div class="px-6 pb-2 text-xs font-semibold text-gray-500 uppercase tracking-wider mt-4">System</div>`;
            sys.forEach(id => html += createLink(id));

            nav.innerHTML = html;
            lucide.createIcons();

            // Header Info
            document.getElementById('roleLabel').innerText = user.role === 'areamanager' ? 'AREA ADMIN' : 'TEAM MEMBER';
            
            // Display assigned area if employee, otherwise show role
            if (user.role === 'employee' && user.area) {
                document.getElementById('headerRole').innerText = user.area; // Show assigned area
                document.getElementById('headerAreaBadge').innerText = user.area; // Show in badge
            } else {
                document.getElementById('headerRole').innerText = user.role;
                document.getElementById('headerAreaBadge').innerText = user.area || 'Global';
            }
            
            document.getElementById('headerName').innerText = user.name;
            document.getElementById('welcomeName').innerText = user.name;

            // Iframe Cleanup
            const frame = document.getElementById('contentFrame');
            frame.addEventListener('load', function() {
                try {
                    const innerDoc = frame.contentDocument || frame.contentWindow.document;
                    const innerSidebar = innerDoc.querySelector('.sidebar');
                    if(innerSidebar) innerSidebar.style.display = 'none';
                    const innerHeader = innerDoc.querySelector('header');
                    if(innerHeader) innerHeader.style.display = 'none';
                } catch (e) {}
            });
        });
    </script>

    <div class="flex h-screen overflow-hidden">
        <aside class="sidebar w-72 flex-shrink-0 hidden md:flex flex-col z-20 overflow-y-auto custom-scrollbar">
            <div class="h-16 flex items-center px-6 border-b border-gray-800 sticky top-0 bg-[#111827] z-10">
                 <div class="flex items-center gap-3">
                     <div class="bg-purple-600 p-1.5 rounded-lg"><i data-lucide="shield" class="w-5 h-5 text-white"></i></div>
                     <div><h1 class="text-xl font-bold text-white">RoomHy</h1><span class="text-[10px] text-gray-500 font-medium tracking-wider" id="roleLabel">AREA ADMIN</span></div>
                 </div>
            </div>
            <nav class="flex-1 py-6 space-y-1" id="dynamicSidebarNav"></nav>
        </aside>

        <div class="flex-1 flex flex-col overflow-hidden bg-[#f3f4f6]">
            <header class="bg-white h-16 flex items-center justify-between px-6 shadow-sm z-10 border-b border-gray-200">
                <div class="flex items-center">
                    <button id="mobile-menu-open" class="md:hidden mr-4 text-slate-500"><i data-lucide="menu" class="w-6 h-6"></i></button>
                    <div class="flex items-center text-sm">
                        <span class="text-slate-500 font-medium mr-2">Assigned Area:</span>
                        <span id="headerAreaBadge" class="px-3 py-1 rounded-full bg-purple-100 text-purple-700 text-xs font-bold uppercase tracking-wide">Loading...</span>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="relative group">
                        <button class="flex items-center gap-3 hover:bg-gray-50 p-1.5 rounded-full transition-colors">
                            <img src="https://i.pravatar.cc/150?u=emp" alt="User" class="w-8 h-8 rounded-full border border-slate-200">
                            <div class="text-left hidden sm:block">
                                <p class="text-xs font-semibold text-gray-700" id="headerName">User</p>
                                <p class="text-[10px] text-gray-500" id="headerRole">Role</p>
                            </div>
                            <i data-lucide="chevron-down" class="w-3 h-3 text-gray-400 hidden sm:block"></i>
                        </button>
                        <div class="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 hidden group-hover:block z-50">
                            <a href="#" id="logoutBtn" class="block px-4 py-2 text-sm text-red-600 hover:bg-gray-100">Logout</a>
                        </div>
                    </div>
                </div>
            </header>

            <div class="flex-1 overflow-hidden relative">
                <main id="dashboard-view" class="h-full overflow-y-auto p-4 md:p-8">
                    <div class="max-w-[1600px] mx-auto">
                        <div class="mb-8 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                            <div>
                                <h1 class="text-2xl font-bold text-slate-800">Welcome, <span id="welcomeName">User</span>!</h1>
                                <p class="text-sm text-slate-500 mt-1">Viewing <span id="welcomeArea" class="font-semibold text-purple-600">Dashboard</span>.</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                             <!-- Dynamic Widgets will appear if allowed -->
                             <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer" onclick="if(allowedModules.includes('properties')) loadPage('areaproperty.html', this)">
                                <div class="flex items-center gap-4">
                                    <div class="p-3 bg-blue-50 rounded-lg text-blue-600"><i data-lucide="home" class="w-6 h-6"></i></div>
                                    <div><h3 class="font-bold text-slate-800">Properties</h3><p class="text-xs text-gray-500">Quick Access</p></div>
                                </div>
                            </div>
                             <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer" onclick="if(allowedModules.includes('tenants')) loadPage('areatenant.html', this)">
                                <div class="flex items-center gap-4">
                                    <div class="p-3 bg-green-50 rounded-lg text-green-600"><i data-lucide="users" class="w-6 h-6"></i></div>
                                    <div><h3 class="font-bold text-slate-800">Tenants</h3><p class="text-xs text-gray-500">Quick Access</p></div>
                                </div>
                            </div>
                             <div class="bg-white p-6 rounded-xl border border-gray-200 shadow-sm hover:shadow-md transition cursor-pointer" onclick="if(allowedModules.includes('chat')) loadPage('areachat.html', this)">
                                <div class="flex items-center gap-4">
                                    <div class="p-3 bg-purple-50 rounded-lg text-purple-600"><i data-lucide="message-square" class="w-6 h-6"></i></div>
                                    <div><h3 class="font-bold text-slate-800">Chat</h3><p class="text-xs text-gray-500">Quick Access</p></div>
                                </div>
                            </div>
                        </div>
                        <div class="mt-8 p-8 bg-white rounded-xl border border-gray-200 text-center">
                            <h3 class="text-lg font-medium text-gray-800">Select a module from the sidebar</h3>
                            <p class="text-gray-500 text-sm mt-1">Your access is controlled by your assigned Area role.</p>
                        </div>
                    </div>
                </main>
                <iframe id="contentFrame" class="hidden" src=""></iframe>
            </div>
        </div>
        
        <div id="mobile-overlay" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
        <aside id="mobile-sidebar" class="fixed inset-y-0 left-0 w-72 bg-[#111827] z-40 transform -translate-x-full transition-transform duration-300 md:hidden flex flex-col overflow-y-auto">
             <nav class="flex-1 py-4 space-y-1 px-2">
                 <a href="#" onclick="loadPage('dashboard_home', null); return false;" class="flex items-center px-4 py-3 text-sm font-medium rounded-md bg-gray-800 text-white border-l-4 border-purple-500">Dashboard</a>
            </nav>
        </aside>
    </div>

    <script>
        document.getElementById('logoutBtn').addEventListener('click', (e) => {
            e.preventDefault();
            localStorage.removeItem('user');
            localStorage.removeItem('manager_user');
            safeRedirect('../index.html');
        });
        function toggleMobileMenu() {
            const sb = document.getElementById('mobile-sidebar');
            const ov = document.getElementById('mobile-overlay');
            if (sb.classList.contains('-translate-x-full')) { sb.classList.remove('-translate-x-full'); ov.classList.remove('hidden'); } 
            else { sb.classList.add('-translate-x-full'); ov.classList.add('hidden'); }
        }
        document.getElementById('mobile-menu-open').addEventListener('click', toggleMobileMenu);
    </script>
</body>
</html>